<div class="min-h-screen py-8 px-4 sm:px-6 lg:px-8">
  <div class="max-w-3xl mx-auto">
    <button
      routerLink="/"
      class="mb-6 flex items-center gap-2 text-blue-600 hover:text-blue-700 font-semibold transition-colors duration-200 animate-fade-in"
    >
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
      Back to All Pets
    </button>

    <div class="bg-white rounded-2xl shadow-xl p-8 animate-fade-in">
      <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Add New Pet</h1>

      <form [formGroup]="petForm" (ngSubmit)="onSubmit()" class="space-y-6">
        <section>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Pet Image <span class="text-red-500">*</span>
          </label>
          <div
            role="button"
            tabindex="0"
            (keydown.enter)="fileInput.click()"
            (keydown.space)="fileInput.click()"
            (click)="fileInput.click()"
            (dragover)="onDragOver($event)"
            (dragleave)="onDragLeave($event)"
            (drop)="onDrop($event)"
            [class.border-primary-500]="isDragOver"
            [class.bg-primary-50]="isDragOver"
            class="flex flex-col items-center justify-center w-full border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer transition-colors"
          >
            <div class="text-gray-500">
              <p class="font-semibold">Drag & drop an image here</p>
              <p class="text-sm">or click to select a file</p>
              <p class="text-xs mt-2">Only images are allowed (max 5MB)</p>
            </div>
            <input
              #fileInput
              type="file"
              accept="image/*"
              class="hidden"
              (change)="onFileInputChange($event)"
            />
          </div>
          @if (imageError) {
            <p class="mt-2 text-sm text-red-600">{{ imageError }}</p>
          }

          @if (imagePreview) {
            <div class="mt-4">
              <div class="flex items-center justify-between mb-2">
                <p class="text-sm text-gray-600">Preview</p>
                <button type="button" (click)="removeImage()" class="text-red-600 hover:text-red-700 text-sm font-semibold">Remove image</button>
              </div>
              <img
                [src]="imagePreview"
                alt="Preview"
                width="640"
                height="400"
                class="w-full max-w-md rounded-lg shadow-md mx-auto"
              />
              <div class="mt-4 flex flex-col items-center justify-center text-center">
                <button
                  type="button"
                  aria-label="Autofill from image using AI"
                  [disabled]="!imagePreview || isAiLoading"
                  (click)="onAiAutofillClick()"
                  [attr.aria-busy]="isAiLoading"
                  class="inline-flex items-center gap-2 bg-primary-600 hover:bg-primary-700 disabled:bg-gray-400 text-white font-semibold px-3 py-2 rounded-md transition-colors text-sm"
                >
                  @if (isAiLoading) {
                    <span class="inline-block h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin" aria-hidden="true"></span>
                    <span>Autofill</span>
                  } @else {
                    <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-4 w-4 fill-current">
                      <path d="M11 2l1.5 4.5L17 8l-4.5 1.5L11 14l-1.5-4.5L5 8l4.5-1.5L11 2zm6 8l.75 2.25L20 13l-2.25.75L17 16l-.75-2.25L14 13l2.25-.75L17 10zm-10 3l.5 1.5L9 15l-1.5.5L7 17l-.5-1.5L5 15l1.5-.5L7 13z"/>
                    </svg>
                    <span>Autofill</span>
                  }
                </button>
                <p class="text-xs text-gray-500 mt-2">Processes your image to suggest fields. You can edit before saving.</p>
                <p class="text-xs text-gray-400">Requires Chrome Prompt API with image input</p>
              </div>
              @if (aiError) {
                <div class="mt-3 bg-red-50 text-red-700 border border-red-200 rounded-lg p-3 text-sm flex items-center justify-between">
                  <span>{{ aiError }}</span>
                  <button type="button" (click)="retryAiAutofill()" class="underline font-semibold">Retry</button>
                </div>
              }
              @if (aiSummary) {
                <div class="mt-3 bg-blue-50 text-blue-800 border border-blue-200 rounded-lg p-3 text-sm flex items-center justify-between">
                  <span>{{ aiSummary }}</span>
                  <button type="button" (click)="dismissAiSummary()" class="underline font-semibold">Dismiss</button>
                </div>
              }
            </div>
          }
        </section>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Pet Name <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            formControlName="name"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
            placeholder="Enter pet name"
          />
          @if (petForm.get('name')?.invalid && petForm.get('name')?.touched) {
            <div class="mt-1 text-sm text-red-600">
              @if (petForm.get('name')?.errors?.['required']) {<span>Name is required.</span>}
              @if (petForm.get('name')?.errors?.['minlength']) {<span>Name must be at least 2 characters.</span>}
            </div>
          }
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Animal Type <span class="text-red-500">*</span>
          </label>
          <select
            formControlName="animalType"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
          >
            <option value="">Select animal type</option>
            <option value="cat">Cat</option>
            <option value="dog">Dog</option>
          </select>
          @if (petForm.get('animalType')?.invalid && petForm.get('animalType')?.touched) {
            <div class="mt-1 text-sm text-red-600">
              Animal type is required.
            </div>
          }
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Breed <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            formControlName="breed"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
            placeholder="Enter breed"
          />
          @if (petForm.get('breed')?.invalid && petForm.get('breed')?.touched) {
            <div class="mt-1 text-sm text-red-600">
              Breed is required.
            </div>
          }
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Gender <span class="text-red-500">*</span>
          </label>
          <div class="flex gap-6">
            <label class="flex items-center cursor-pointer">
              <input
                type="radio"
                formControlName="gender"
                value="male"
                class="w-4 h-4 text-primary-600 focus:ring-primary-500"
              />
              <span class="ml-2 text-gray-700">Male</span>
            </label>
            <label class="flex items-center cursor-pointer">
              <input
                type="radio"
                formControlName="gender"
                value="female"
                class="w-4 h-4 text-primary-600 focus:ring-primary-500"
              />
              <span class="ml-2 text-gray-700">Female</span>
            </label>
          </div>
          @if (petForm.get('gender')?.invalid && petForm.get('gender')?.touched) {
            <div class="mt-1 text-sm text-red-600">
              Gender is required.
            </div>
          }
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Age <span class="text-red-500">*</span>
          </label>
          <div class="flex gap-4">
            <div class="flex-1">
              <label class="block text-xs text-gray-600 mb-1">Years</label>
              <input
                type="number"
                formControlName="ageYears"
                min="0"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
                placeholder="0"
              />
              @if (petForm.get('ageYears')?.invalid && petForm.get('ageYears')?.touched) {
                <div class="mt-1 text-sm text-red-600">
                  @if (petForm.get('ageYears')?.errors?.['required']) {<span>Years is required.</span>}
                  @if (petForm.get('ageYears')?.errors?.['min']) {<span>Years must be 0 or greater.</span>}
                </div>
              }
            </div>
            <div class="flex-1">
              <label class="block text-xs text-gray-600 mb-1">Months</label>
              <input
                type="number"
                formControlName="ageMonths"
                min="0"
                max="11"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
                placeholder="0"
              />
              @if (petForm.get('ageMonths')?.invalid && petForm.get('ageMonths')?.touched) {
                <div class="mt-1 text-sm text-red-600">
                  @if (petForm.get('ageMonths')?.errors?.['required']) {<span>Months is required.</span>}
                  @if (petForm.get('ageMonths')?.errors?.['min']) {<span>Months must be 0 or greater.</span>}
                  @if (petForm.get('ageMonths')?.errors?.['max']) {<span>Months must be 11 or less.</span>}
                </div>
              }
            </div>
          </div>
          @if (petForm.errors?.['ageRequired'] && (petForm.get('ageYears')?.touched || petForm.get('ageMonths')?.touched)) {
            <div class="mt-1 text-sm text-red-600">
              At least one of years or months must be greater than 0.
            </div>
          }
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Location <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            formControlName="location"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
            placeholder="City, State"
          />
          @if (petForm.get('location')?.invalid && petForm.get('location')?.touched) {
            <div class="mt-1 text-sm text-red-600">
              Location is required.
            </div>
          }
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            Adoption Date Available <span class="text-red-500">*</span>
          </label>
          <input
            type="date"
            formControlName="adoptionDate"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent transition-all"
          />
          @if (petForm.get('adoptionDate')?.invalid && petForm.get('adoptionDate')?.touched) {
            <div class="mt-1 text-sm text-red-600">
              Adoption date is required.
            </div>
          }
        </div>

        

        <div>
          <div class="flex items-center justify-between mb-2">
            <label class="block text-sm font-semibold text-gray-700">
              Description
            </label>
            @if ((petForm.get('description')?.value?.length ?? 0) >= 10) {
              <button
                type="button"
                (click)="onImproveDescriptionClick()"
                [disabled]="isImprovingDescription"
                class="inline-flex items-center gap-2 text-primary-700 hover:text-primary-800 disabled:text-gray-400 text-sm font-semibold"
              >
                @if (isImprovingDescription) {
                  <span class="inline-block h-4 w-4 border-2 border-current border-t-transparent rounded-full animate-spin" aria-hidden="true"></span>
                  <span>Improve description</span>
                } @else {
                  <svg aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-4 w-4 fill-current">
                    <path d="M11 2l1.5 4.5L17 8l-4.5 1.5L11 14l-1.5-4.5L5 8l4.5-1.5L11 2zm6 8l.75 2.25L20 13l-2.25.75L17 16l-.75-2.25L14 13l2.25-.75L17 10zm-10 3l.5 1.5L9 15l-1.5.5L7 17l-.5-1.5L5 15l1.5-.5L7 13z"/>
                  </svg>
                  <span>Improve description</span>
                }
              </button>
            }
          </div>
          <textarea
            formControlName="description"
            rows="4"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent focus:outline-none transition-all resize-y"
            placeholder="Tell us about this pet (personality, preferences, etc.)"
          ></textarea>
          <p class="mt-1 text-sm text-gray-500">Optional: 3-4 sentences about the pet</p>
          @if (improveDescError) {
            <div class="mt-2 bg-red-50 text-red-700 border border-red-200 rounded-lg p-2 text-sm">
              {{ improveDescError }}
            </div>
          }
        </div>

        <div class="flex gap-4 pt-4">
          <button
            type="submit"
            [disabled]="petForm.invalid || isSubmitting"
            class="flex-1 bg-gradient-to-r from-primary-500 to-primary-600 hover:from-primary-600 hover:to-primary-700 disabled:from-gray-400 disabled:to-gray-400 disabled:cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg"
          >
            {{ isSubmitting ? 'Adding Pet...' : 'Add Pet' }}
          </button>
          <button
            type="button"
            routerLink="/"
            class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold py-3 px-6 rounded-lg transition-colors duration-200"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>
  </div>
</div>


